<!DOCTYPE html>
<html>
<head></head>
<body>

<!-- ---------------------------------------- -->
<!-- View two split window -->
<div align="left">
<table style='text-align: left; width: 500px; display:block'>
<tr>

<!-- ---------------------------------------- -->
<th id="outputs">
<h3 id="table_h3" style="display:block">[Step 0] Input a statement or question to gift recipient</h3>
<!-- View output in table -->
<input id="input_text" type="text" value="" placeholder="" rows="10" cols="100" style="display:block; text-align: left; height: 50px; width:600px;"><button id="run_selection" onclick="run_selection()">Run Selection</button>
<table id="chatbot_output" style='text-align: left; width: 300px; display:none'>
<!-- dynamically add rows here -->
</table>
</th>
<!-- ---------------------------------------- -->

<!-- ---------------------------------------- -->
<th id="inputs">
<h3>[Step 1] View processing feedback</h3>
<div id="notification"></div>
<div id="error"></div>
<div id="response"></div>
<div id="output_file_path"></div>
<br>
<h3>[Step 2] Maintain your chatbot gift model</h3>
<br>
<h4>Add QUOTE_TO_CHATBOT_API_KEY</h4>
<input id="QUOTE_TO_CHATBOT_API_KEY" type="text" value="" placeholder="QUOTE_TO_CHATBOT_API_KEY" rows="5" cols="100" style="display:block; text-align: left; height: 50px; width:600px;">
<button id="add_QUOTE_TO_CHATBOT_API_KEY" style="display:block; onclick="add_QUOTE_TO_CHATBOT_API_KEY()">Add QUOTE_TO_CHATBOT_API_KEY</button>
<br>
<h4>Add data to chatbot model</h4>
<input id="data_text" type="text" value="" placeholder="Add text to your chatbot" rows="10" cols="100" style="display:block; text-align: left; height: 50px; width:600px;">
<button id="add_data_text" style="display:block; onclick="add_data_text()">Add data to chatbot model</button>
<br>
<h4>Add chatbot model API_KEY</h4>
<input id="API_KEY" type="text" value="" placeholder="API_KEY" rows="5" cols="100" style="display:block; text-align: left; height: 50px; width:600px;">
<button id="add_API_KEY" style="display:block; onclick="add_API_KEY()">Add API_KEY</button>
</th>
<!-- ---------------------------------------- -->

</tr>
</table>
</div>  
<!-- ---------------------------------------- -->

<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div { padding: 10px; display:block; font-family:courier; font-size:15px; height:10px; }
	
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }

div#response { display:none; color: #3236a8; }
div#output_file_path { display:none; }

table {vertical-align: top; border-collapse: collapse; position: relative; z-index: 0; border: 0px solid black;}

tr {vertical-align: top; border: 0px solid black; padding: 20px 10px; }

th, td {vertical-align: top; border: 0px solid black; padding: 20px 10px; }

input#input_text {background-color: #acbdac; border: 0.5px grey; -webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;}
</style>

<!-- --------------------------------------------------- -->

<script type="module" src="./index.js"></script>

<!-- --------------------------------------------------- -->


<script>

// -----------------------------------------------
	
window.addEventListener('beforeunload', function() {
    window.location.href = window.location.href + '?nocache=' + new Date().getTime();
});

// -----------------------------------------------

var RepoAobj = {};
  
RepoAobj.repoOwner = "CodeSolutions2";
RepoAobj.repoA_name = "quote_to_chatbot_gifts/gift0";
RepoAobj.repoB_name = "frontend_backend_message_passing_central_repository_v1";
RepoAobj.foldername = "quote_to_chatbot_gifts/gift0";
  
  
// -----------------------------------------------

async function run_selection() {
	
	// Run model
	await Gemini_textgeneration_w_quotes();
}

// -----------------------------------------------

async function GET_repo_file_info_RESTAPI_fast(RepoAobj) {
	
	return await fetch(`https://raw.githubusercontent.com/${RepoAobj.repoOwner}/${RepoAobj.repoB_name}/main/${RepoAobj.foldername}/${RepoAobj.filename}`)
		.then(res => res.text())
		.then(async function (text_out) { return text_out; })
		.catch(error => { console.log(error); });
}

// -----------------------------------------------




  
// -----------------------------------------------
// Frontend
// -----------------------------------------------
async function add_QUOTE_TO_CHATBOT_API_KEY() {
	
	RepoAobj.filename = "QUOTE_TO_CHATBOT_API_KEY.env";
	RepoAobj.input_text = document.getElementById("QUOTE_TO_CHATBOT_API_KEY").value+"|"+RepoAobj.repoA_name;
	RepoAobj.append_text = "do_not_append"; // "append_unique", "append_non_unique", "do_not_append"
	RepoAobj.type_of_encryption = "hexadecimal"; // "window_crypto_subtle", "hexadecimal"

	console.log("RepoAobj: ", RepoAobj);
	
	const classObj = new encrypted_CRUD_file_database(RepoAobj);
	const obj = await classObj.add_data_to_file();

	document.getElementById("notification").innerHTML = obj.query_insert_result;
}

// -----------------------------------------------

async function add_data() {

	const classObj = new encrypted_CRUD_file_database(RepoAobj);

	// 0. Verify that QUOTE_TO_CHATBOT_API_KEY.env exists
	RepoAobj.filename = "QUOTE_TO_CHATBOT_API_KEY.env";
	console.log("RepoAobj: ", RepoAobj);
	
	const text_out = await GET_repo_file_info_RESTAPI_fast(RepoAobj);
	console.log("text_out: ", text_out);
	
	// 1. If QUOTE_TO_CHATBOT_API_KEY.env exists, verify that the QUOTE_TO_CHATBOT_API_KEY is valid
	if (text_out != '404: Not Found') {
		// QUOTE_TO_CHATBOT_API_KEY.env does not exist
		document.getElementById("notification").innerHTML = "No username for your account exist. Enter your desired QUOTE_TO_CHATBOT_API_KEY to create a username, and click the add_QUOTE_TO_CHATBOT_API_KEY button.";

		// 2. Tell people to reuse the app and add_QUOTE_TO_CHATBOT_API_KEY
	} else {
		// QUOTE_TO_CHATBOT_API_KEY.env does exists
		RepoAobj.input_text = document.getElementById("QUOTE_TO_CHATBOT_API_KEY").value+"|"+RepoAobj.repoA_name;
		var obj = await classObj.search_username_to_file_database();
		
		if (obj.query_search_result == "Present") {
			document.getElementById("notification").innerHTML = "Your username was confirmed.";

			RepoAobj.filename = "encyrpted_file.txt";
			RepoAobj.input_text = document.getElementById("add_data_text").value;
			RepoAobj.append_text = "append_non_unique"; // "append_unique", "append_non_unique", "do_not_append"
			RepoAobj.type_of_encryption = "window_crypto_subtle"; // "window_crypto_subtle", "hexadecimal"
			obj = await classObj.add_data_to_file();

			document.getElementById("notification").innerHTML += obj.query_insert_result;
			
		} else {
			document.getElementById("notification").innerHTML = "Your username was not correct, please try again.";
			// **** Need to add contact or reset password information ****
		}
	}
	
}

// -----------------------------------------------

async function get_data_from_encrypted_file() {
	
	RepoAobj.filename = "encyrpted_file.txt";
	RepoAobj.input_text = "";
	RepoAobj.append_text = "append_non_unique"; // "append_unique", "append_non_unique", "do_not_append"
	RepoAobj.type_of_encryption = "window_crypto_subtle"; // "window_crypto_subtle", "hexadecimal"
  
	const classObj = new encrypted_CRUD_file_database(RepoAobj);
	const obj = await classObj.get_decrypted_file_data();

  return obj.decrypted_file_database;
		
}
	
// -----------------------------------------------

async function add_API_KEY() {
	
	RepoAobj.filename = "API_KEY.env";
	RepoAobj.input_text = document.getElementById("API_KEY").value+"|"+RepoAobj.repoA_name;
	RepoAobj.append_text = "do_not_append"; // "append_unique", "append_non_unique", "do_not_append"
	RepoAobj.type_of_encryption = "hexadecimal"; // "window_crypto_subtle", "hexadecimal"

	console.log("RepoAobj.input_text: ", RepoAobj.input_text);
	
	const classObj = new encrypted_CRUD_file_database(RepoAobj);
	const obj = await classObj.add_data_to_file();

	document.getElementById("notification").innerHTML = obj.query_insert_result;
}
	
// -----------------------------------------------

async function Gemini_textgeneration_w_quotes() {
	
	document.getElementById('notification').innerHTML = "Gemini is processing your request"; 

	// -----------------------------------------
	
	// Get encrypted data from v1
	const quotes_data = await get_data_from_encrypted_file();
	// OR
	// Get data from chromadb
	// const quotes_data = await get_data_from_encrypted_file();

	// -----------------------------------------
	
	const prompt = "Respond to the given question: "+document.getElementById("input_text").value+", using the following information: "+quotes_data+". If the question can not be responded to using the information, return 'The question could not be answered using the inputted data'.";

	// -----------------------------------------

	// Get Model API_KEY
	RepoAobj.filename = "API_KEY.env";
	RepoAobj.input_text = "";
	RepoAobj.append_text = "do_not_append"; // "append_unique", "append_non_unique", "do_not_append"
	RepoAobj.type_of_encryption = "hexadecimal"; // "window_crypto_subtle", "hexadecimal"
	
	console.log("RepoAobj: ", RepoAobj);
	
	const text_out = await GET_repo_file_info_RESTAPI_fast(RepoAobj);
	console.log("text_out: ", text_out);
	
	// RepoAobj.filename does not exist, so ask to create a API_KEY.env file
	if (text_out != '404: Not Found') {
		// Ask the user to enter an API_KEY
		document.getElementById("notification").innerHTML = "No model API_KEY for your account exist. Follow the instructions in Step 2: Enter your desired API_KEY to run the model, and click the add_API_KEY button.";
	} else {
		// Verify that the person can use the webapp
		RepoAobj.input_text = document.getElementById("QUOTE_TO_CHATBOT_API_KEY").value+"|"+RepoAobj.repoA_name;
		var obj = await classObj.search_username_to_file_database();
		
		if (obj.query_search_result == "Present") {
			document.getElementById("notification").innerHTML = "Your username was confirmed.";
			
			// Get the API_KEY
			obj = await classObj.get_decrypted_file_data();
			document.getElementById("notification").innerHTML += obj.query_view_result;
			const API_KEY = obj.decrypted_file_database;
			delete obj.decrypted_file_database;

			var url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
			var headers = {"Content-Type": "application/json"};
			var data = {"contents": [{"parts": [{"text": prompt}]}]};
			var options = {method : 'POST', headers: headers, body : JSON.stringify(data)};
			await fetch(url, options)
				.then(res => res.json())
				.then(async function(res) {
					console.log("result: ", res);
					document.getElementById('response').innerHTML += res; 
					await print_response_to_frontend();
				})
				.then(async function() { document.getElementById('notification').innerHTML = "Processing finished"; })
				.catch(error => { document.getElementById('error').innerHTML = error; });
			
		} else {
			document.getElementById("notification").innerHTML = "Your username was not correct, please try again.";
			// **** Need to add contact or reset password information ****
		}
	}
	
}

// -----------------------------------------------

  
async function get_data_from_chromadb() {

  console.log('to do');
	
}

// -----------------------------------------------

  
async function print_response_to_frontend() {

	document.getElementById("chatbot_output").style.display = "block";
	
	// Print response to Frontend here
	let tbl = document.getElementById("chatbot_output");
	let tblBody = document.createElement("tbody");
	
	// Add to Frontend: Create a cellText OR textarea
	let row = document.createElement("tr");
	let cell = document.createElement("td");
	cell.style.backgroundColor = "#cacccf";
	let cellText = document.createTextNode(`User: ${document.getElementById("input_text").value}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);
	
	// Add chatbot output to Frontend: Create a cellText OR textarea
	row = document.createElement("tr");
	cell = document.createElement("td");
	cell.style.backgroundColor = "#dbc49e";
	cellText = document.createTextNode(`Chatbot: ${document.getElementById('response').innerHTML}`);
	cell.appendChild(cellText);
	cell.style.border = "10px solid rgba(0, 0, 0, 0)";
	row.appendChild(cell);
	tblBody.appendChild(row);
	tbl.appendChild(tblBody);

	// Reset response
	document.getElementById('response').textContent = "";
	
}

// -----------------------------------------------



</script>

  
</body>
</html>
